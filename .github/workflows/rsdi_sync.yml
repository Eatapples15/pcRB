name: RSDI, DPC and EFFIS Data Sync

on:
  workflow_dispatch: # Avvio manuale
  schedule:
    - cron: '0 0 * * 1' # Esecuzione automatica ogni lunedì a mezzanotte

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. Installazione Dipendenze
        run: |
          python -m pip install --upgrade pip
          pip install requests pyproj pyshp

      - name: 4. Estrazione Layer Tecnici RSDI
        run: |
          if [ -f "rsdi_extractor.py" ]; then
            python rsdi_extractor.py
          else
            echo "⚠️ Script rsdi_extractor.py non trovato."
          fi

      - name: 5. Estrazione Aggregati Strutturali DPC
        run: |
          if [ -f "dpc_aggregati_extractor.py" ]; then
            python dpc_aggregati_extractor.py
          else
            echo "⚠️ Script dpc_aggregati_extractor.py non trovato."
          fi

      - name: 6. Estrazione Incendi EFFIS (Copernicus)
        run: |
          if [ -f "effis_extractor.py" ]; then
            python effis_extractor.py
          else
            echo "⚠️ Script effis_extractor.py non trovato."
          fi

      - name: 7. Verifica esistenza file generati
        run: ls -lh *.geojson || echo "Nessun file trovato"

      - name: 8. Commit e Push dei Dati
        run: |
          git config --global user.name "Data-Master-Bot"
          git config --global user.email "bot@pcbasilicata.it"
          # Aggiunge tutti i layer tecnici, sismici e incendi
          git add rsdi_*.geojson dpc_*.geojson effis_*.geojson
          git commit -m "Sync automatico RSDI/DPC/EFFIS: $(date +'%d-%m-%Y')" || echo "Nessuna modifica rilevata"
          git push
