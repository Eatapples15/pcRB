name: RSDI and DPC Data Sync

on:
  workflow_dispatch: # Permette l'avvio manuale cliccando "Run workflow"
  schedule:
    - cron: '0 0 * * 1' # Esecuzione automatica ogni lunedì a mezzanotte

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. Installazione Dipendenze (Cruciale)
        run: |
          python -m pip install --upgrade pip
          pip install requests pyproj pyshp

      - name: 4. Estrazione Layer Tecnici RSDI
        run: |
          if [ -f "rsdi_extractor.py" ]; then
            python rsdi_extractor.py
          else
            echo "⚠️ Script rsdi_extractor.py non trovato, salto lo step."
          fi

      - name: 5. Estrazione Aggregati Strutturali DPC
        run: |
          if [ -f "dpc_aggregati_extractor.py" ]; then
            python dpc_aggregati_extractor.py
          else
            echo "⚠️ Script dpc_aggregati_extractor.py non trovato, salto lo step."
          fi

      - name: 6. Check File Existence
        run: ls -lh rsdi_*.geojson dpc_*.geojson || echo "Nessun nuovo file generato"

      - name: 7. Commit e Push dei Dati
        run: |
          git config --global user.name "RSDI-Master-Bot"
          git config --global user.email "bot@pcbasilicata.it"
          # Aggiunge tutti i file GeoJSON tecnici e sismici
          git add rsdi_*.geojson dpc_*.geojson
          git commit -m "Sync automatico RSDI/DPC: $(date +'%d-%m-%Y')" || echo "Nessuna modifica rilevata"
          git push
